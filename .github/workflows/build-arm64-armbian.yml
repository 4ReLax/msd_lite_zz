# 文件路径: .github/workflows/build-arm64-armbian.yml
name: Build ARM64 for Armbian

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发工作流

env:
  BUILD_TYPE: Release

jobs:
  build-cross-compile:
    name: Cross-compile for ARM64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
    
    - name: Install ARM64 cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          libcunit1-dev \
          file \
          qemu-user-static \
          binfmt-support
        
    - name: Create build directory
      run: cmake -E make_directory ${{github.workspace}}/build-arm64
    
    - name: Configure CMake for ARM64 cross-compilation
      working-directory: ${{github.workspace}}/build-arm64
      run: |
        cmake $GITHUB_WORKSPACE \
          -DCMAKE_SYSTEM_NAME=Linux \
          -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DENABLE_TESTS=1
        
    - name: Build for ARM64
      working-directory: ${{github.workspace}}/build-arm64
      run: cmake --build . --config ${{ env.BUILD_TYPE }} -j $(nproc)
    
    - name: Verify ARM64 binary
      run: |
        file ${{github.workspace}}/build-arm64/src/msd_lite
        echo "Binary architecture:"
        aarch64-linux-gnu-objdump -f ${{github.workspace}}/build-arm64/src/msd_lite | grep architecture || true
        
    - name: Run tests with QEMU emulation
      working-directory: ${{github.workspace}}/build-arm64
      run: |
        # 使用 QEMU 在 x86 上运行 ARM64 测试
        if command -v qemu-aarch64-static > /dev/null; then
          export QEMU_LD_PREFIX=/usr/aarch64-linux-gnu
          ctest -C ${{ env.BUILD_TYPE }} --output-on-failure -j 4 --timeout 300 || echo "Some tests may fail under emulation"
        else
          echo "QEMU not available, skipping tests"
        fi
        
    - name: Create Armbian package
      run: |
        mkdir -p ${{github.workspace}}/package-arm64
        cp ${{github.workspace}}/build-arm64/src/msd_lite ${{github.workspace}}/package-arm64/
        cp ${{github.workspace}}/config/msd_lite.conf.example ${{github.workspace}}/package-arm64/msd_lite.conf.example
        cp ${{github.workspace}}/README.md ${{github.workspace}}/package-arm64/
        
        # 创建安装脚本
        cat > ${{github.workspace}}/package-arm64/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing msd_lite for ARM64 Armbian..."
        sudo cp msd_lite /usr/local/bin/
        sudo mkdir -p /etc/msd_lite
        sudo cp msd_lite.conf.example /etc/msd_lite/msd_lite.conf
        echo "Installation complete!"
        echo "Edit /etc/msd_lite/msd_lite.conf to configure your network interface"
        EOF
        chmod +x ${{github.workspace}}/package-arm64/install.sh
        
        # 创建 systemd 服务文件
        cat > ${{github.workspace}}/package-arm64/msd-lite.service << 'EOF'
        [Unit]
        Description=MSD Lite Multicast Stream Daemon
        After=network.target
        
        [Service]
        Type=simple
        ExecStart=/usr/local/bin/msd_lite -d -c /etc/msd_lite/msd_lite.conf
        Restart=on-failure
        RestartSec=5
        
        [Install]
        WantedBy=multi-user.target
        EOF
        
        cd ${{github.workspace}}/package-arm64
        tar -czf ../msd_lite-arm64-armbian.tar.gz .
        
    - name: Upload ARM64 Armbian package
      uses: actions/upload-artifact@v3
      with:
        name: msd_lite-arm64-armbian
        path: |
          ${{github.workspace}}/msd_lite-arm64-armbian.tar.gz
          ${{github.workspace}}/build-arm64/src/msd_lite
        retention-days: 30
        
    - name: Upload to release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{github.workspace}}/msd_lite-arm64-armbian.tar.gz
          ${{github.workspace}}/build-arm64/src/msd_lite

  build-native-docker:
    name: Build using Docker ARM64
    runs-on: ubuntu-latest
    if: false  # 设置为 true 如果需要 Docker 构建
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
        
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Build with Docker
      run: |
        docker run --rm --platform linux/arm64 \
          -v $PWD:/workspace \
          -w /workspace \
          arm64v8/ubuntu:20.04 \
          /bin/bash -c "
          apt-get update && apt-get install -y cmake build-essential libcunit1-dev &&
          mkdir build && cd build &&
          cmake .. -DCMAKE_BUILD_TYPE=Release &&
          make -j\$(nproc)
          "

  deploy-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    needs: build-cross-compile
    if: always()
    
    steps:
    - name: Show deployment instructions
      run: |
        echo "=== ARM64 Armbian 部署说明 ==="
        echo "1. 下载构建产物 msd_lite-arm64-armbian"
        echo "2. 上传到 Armbian 设备并解压:"
        echo "   tar -xzf msd_lite-arm64-armbian.tar.gz"
        echo "3. 运行安装脚本:"
        echo "   sudo ./install.sh"
        echo "4. 编辑配置文件:"
        echo "   sudo nano /etc/msd_lite/msd_lite.conf"
        echo "5. 启动服务:"
        echo "   sudo systemctl daemon-reload"
        echo "   sudo systemctl enable msd-lite"
        echo "   sudo systemctl start msd-lite"
