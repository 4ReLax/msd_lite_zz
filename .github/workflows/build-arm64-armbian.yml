name: build-armbian-arm64

on: [push, pull_request]

env:
  # 编译类型（Release/Debug等）
  BUILD_TYPE: Release

jobs:
  build:
    # 使用支持ARM64的runner（官方Ubuntu ARM64或自托管Armbian runner）
    runs-on: ubuntu-latest
    # 若有自托管的Armbian ARM64 runner，替换为：runs-on: [self-hosted, arm64, armbian]
    
    strategy:
      matrix:
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive' # 拉取子模块（项目依赖liblcb）

    - name: Set up ARM64 build environment (Armbian)
      run: |
        # 更新源并安装基础依赖
        sudo apt-get update -y
        # 安装编译依赖（与Ubuntu一致，Armbian兼容Debian/apt体系）
        sudo apt-get install -y \
          build-essential \
          git \
          cmake \
          libcunit1 \
          libcunit1-doc \
          libcunit1-dev \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu
        # 若为自托管Armbian runner，可跳过交叉编译工具链（直接用系统gcc/clang）

    - name: Create Build Directory
      run: cmake -E make_directory ${{ github.workspace }}/build

    - name: Configure CMake (ARM64)
      shell: bash
      working-directory: ${{ github.workspace }}/build
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
      run: |
        # 针对ARM64架构配置CMake
        cmake $GITHUB_WORKSPACE \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DENABLE_TESTS=1 \
          -DCMAKE_SYSTEM_PROCESSOR=arm64 \
          # 若为交叉编译，添加以下两行（自托管runner可移除）
          # -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          # -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++

    - name: Build msd_lite
      working-directory: ${{ github.workspace }}/build
      shell: bash
      run: cmake --build . --config $BUILD_TYPE -j $(nproc) # 自动适配CPU核心数

    - name: Run Tests (可选)
      working-directory: ${{ github.workspace }}/build
      shell: bash
      run: ctest -C $BUILD_TYPE -j $(nproc) --output-on-failure

    - name: Upload ARM64 binary (可选)
      uses: actions/upload-artifact@v4
      with:
        name: msd_lite-arm64-${{ matrix.compiler }}
        path: ${{ github.workspace }}/build/src/msd_lite
