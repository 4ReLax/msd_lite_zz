name: build-arm64-armbian

on: [push, pull_request]

env:
  BUILD_TYPE: Release

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
    
    - name: Setup ARM64 cross-compilation environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          libcunit1-dev \
          file
        
    - name: Create cross-compilation toolchain file
      run: |
        cat > arm64-toolchain.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR aarch64)
        
        set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
        set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
        
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
        EOF
    
    - name: Create build directory
      run: cmake -E make_directory build-arm64
    
    - name: Configure CMake for ARM64
      working-directory: ./build-arm64
      run: |
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../arm64-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DENABLE_TESTS=0
        
    - name: Build for ARM64
      working-directory: ./build-arm64
      run: cmake --build . --config ${{ env.BUILD_TYPE }} -j $(nproc)
    
    - name: Check ARM64 binary
      run: |
        file build-arm64/src/msd_lite
        aarch64-linux-gnu-objdump -f build-arm64/src/msd_lite | grep -i architecture
    
    - name: Upload ARM64 artifact
      uses: actions/upload-artifact@v3
      with:
        name: msd_lite-arm64-binary
        path: |
          build-arm64/src/msd_lite
        retention-days: 30

  build-native-arm64:
    runs-on: [self-hosted, arm64]
    if: false  # 设置为 true 如果你有 ARM64 自托管运行器
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
    
    - name: Install dependencies on Armbian
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libcunit1-dev \
          git
        
    - name: Create build directory
      run: cmake -E make_directory build
    
    - name: Configure CMake natively
      working-directory: ./build
      run: |
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DENABLE_TESTS=1
        
    - name: Build natively
      working-directory: ./build
      run: cmake --build . --config ${{ env.BUILD_TYPE }} -j $(nproc)
    
    - name: Run tests
      working-directory: ./build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure
    
    - name: Create release package
      run: |
        mkdir -p package
        cp build/src/msd_lite package/
        cp config/msd_lite.conf.example package/
        tar -czf msd_lite-arm64.tar.gz package/
        
    - name: Upload release
      uses: actions/upload-artifact@v3
      with:
        name: msd_lite-arm64-release
        path: msd_lite-arm64.tar.gz
